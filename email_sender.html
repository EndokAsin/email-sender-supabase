<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengirim Email Massal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ikon Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 800px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container bg-white rounded-2xl shadow-xl p-8 md:p-12 space-y-8">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Pengirim Email Massal</h1>
            <p class="text-gray-500">Kirim email ke banyak penerima dengan mudah. </p>
            <p class="text-sm mt-4 text-red-500 font-semibold">
                *Catatan Penting: Ini adalah versi DEMO. Untuk aplikasi nyata, pengiriman email dan pemrosesan file harus dilakukan di server (backend) untuk keamanan.
            </p>
        </header>

        <form id="emailForm" class="space-y-6">
            <!-- Unggah File CSV -->
            <div>
                <label for="excelFile" class="block text-sm font-medium text-gray-700 mb-2">Unggah Daftar Penerima (CSV atau XLSX)</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a2 2 0 00-2 2v14m16-4h-4l-3-3m0 0l-3 3m3-3V12m2 8V28h4V20m-4-8h4v16H20m0 0V8h-8v20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="excelFile" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                <span>Pilih file</span>
                                <input id="excelFile" name="excelFile" type="file" class="sr-only" accept=".csv, .xlsx">
                            </label>
                            <p class="pl-1">atau seret dan lepas di sini</p>
                        </div>
                        <p id="fileName" class="text-xs text-gray-500"></p>
                    </div>
                </div>
            </div>

            <!-- Unggah File Lampiran -->
            <div>
                <label for="attachmentFile" class="block text-sm font-medium text-gray-700 mb-2">Unggah File Lampiran (Opsional)</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12h.01m17.5 0h.01M6.87 18.06l-.51-.12c-.93-.22-1.85.12-2.31.96-1.12 2.05-3.08 1.13-2.92-.88a1.5 1.5 0 01.37-.56l1.3-1.3c.6-.6.6-1.57 0-2.17l-.55-.56a1.5 1.5 0 010-2.12l1.3-1.3c.6-.6.6-1.57 0-2.17l-.55-.56a1.5 1.5 0 01-.19-2.06c.47-.84 1.39-1.18 2.32-.96l.51.12.51.12c.93.22 1.85-.12 2.31-.96a1.5 1.5 0 012.92.88c.16 1.13-.8 2.05-2.08 2.31l-.51.12z" />
                        </svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="attachmentFile" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                <span>Pilih file</span>
                                <input id="attachmentFile" name="attachments" type="file" multiple class="sr-only">
                            </label>
                            <p class="pl-1">atau seret dan lepas di sini</p>
                        </div>
                        <p id="attachmentFileName" class="text-xs text-gray-500"></p>
                    </div>
                </div>
            </div>

            <!-- Subjek Email -->
            <div>
                <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">Subjek Email</label>
                <input type="text" id="subject" name="subject" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
            </div>

            <!-- Isi Pesan -->
            <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Isi Pesan</label>
                <textarea id="message" name="message" rows="6" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
            </div>

            <button type="submit" id="submitBtn" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                <span id="buttonText">Kirim Email Massal</span>
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>

        <!-- Area Pesan Status -->
        <div id="statusMessage" class="mt-6 p-4 rounded-md hidden"></div>
    </div>

    <script type="module">
        // Impor Supabase SDK dari CDN
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Variabel global untuk instance Supabase
        let supabase;

        // Inisialisasi Supabase
        const SUPABASE_URL = 'https://wdqaxzkhgmghepoavfim.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcWF4emtoZ21naGVwb2F2ZmltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NTMyMjksImV4cCI6MjA3NDEyOTIyOX0.z5FbhxeK7Go2YOfQZxPPjGwM_Hx_goF9JWFl_dp-wSc';

        // Fungsi untuk menginisialisasi Supabase
        const initializeSupabase = () => {
            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized successfully.');
            } catch (error) {
                console.error('Error initializing Supabase:', error);
            }
        };

        // Memanggil inisialisasi saat script dimuat
        initializeSupabase();

        // Elemen DOM
        const form = document.getElementById('emailForm');
        const fileInput = document.getElementById('excelFile');
        const attachmentInput = document.getElementById('attachmentFile');
        const fileNameSpan = document.getElementById('fileName');
        const attachmentFileNameSpan = document.getElementById('attachmentFileName');
        const statusMessageDiv = document.getElementById('statusMessage');
        const submitBtn = document.getElementById('submitBtn');
        const buttonTextSpan = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');

        // Event listener untuk menampilkan nama file yang diunggah
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                fileNameSpan.textContent = file.name;
                fileNameSpan.classList.remove('text-gray-500');
                fileNameSpan.classList.add('text-green-600');
            } else {
                fileNameSpan.textContent = '';
            }
        });
        
        // Event listener untuk menampilkan nama file lampiran yang diunggah
        attachmentInput.addEventListener('change', () => {
            const files = attachmentInput.files;
            if (files.length > 0) {
                const fileNames = Array.from(files).map(file => file.name).join(', ');
                attachmentFileNameSpan.textContent = `${files.length} file dipilih: ${fileNames}`;
                attachmentFileNameSpan.classList.remove('text-gray-500');
                attachmentFileNameSpan.classList.add('text-green-600');
            } else {
                attachmentFileNameSpan.textContent = '';
            }
        });

        // Event listener untuk pengiriman formulir
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Mencegah form untuk refresh halaman

            // Ambil data dari formulir
            const file = fileInput.files[0];
            const attachments = attachmentInput.files;
            const subject = document.getElementById('subject').value;
            const message = document.getElementById('message').value;

            // Validasi sederhana
            if (!file) {
                showStatus('danger', 'Silakan unggah file CSV terlebih dahulu.');
                return;
            }

            // Tampilkan status "loading"
            submitBtn.disabled = true;
            buttonTextSpan.textContent = 'Mengirim...';
            spinner.classList.remove('hidden');
            showStatus('info', 'Mengirim data ke server...');

            // --- Panggilan Nyata ke Supabase Edge Function ---
            try {
                // Buat objek FormData untuk mengirim file
                const formData = new FormData();
                formData.append('file', file);
                formData.append('subject', subject);
                formData.append('message', message);
                
                // Tambahkan lampiran ke FormData
                for (let i = 0; i < attachments.length; i++) {
                    formData.append('attachments', attachments[i]);
                }
                
                // Panggil Edge Function 'send-emails'
                const { data, error } = await supabase.functions.invoke('send-emails', {
                    method: 'POST',
                    body: formData,
                });

                if (error) {
                    throw error;
                }

                if (data.status === 'success') {
                    showStatus('success', 'Email berhasil dikirim ke daftar penerima!');
                } else {
                    showStatus('danger', `Gagal mengirim email: ${data.message}`);
                }
                
                // Kosongkan formulir setelah pengiriman berhasil
                form.reset();
                fileNameSpan.textContent = '';
                attachmentFileNameSpan.textContent = '';
                
            } catch (error) {
                console.error('Panggilan fungsi gagal:', error);
                showStatus('danger', `Gagal mengirim email: ${error.message || 'Terjadi kesalahan.'}`);
            } finally {
                // Sembunyikan status "loading"
                submitBtn.disabled = false;
                buttonTextSpan.textContent = 'Kirim Email Massal';
                spinner.classList.add('hidden');
            }
        });

        // Fungsi untuk menampilkan pesan status
        function showStatus(type, message) {
            statusMessageDiv.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'text-red-700', 'text-green-700', 'text-blue-700');
            statusMessageDiv.textContent = message;

            if (type === 'success') {
                statusMessageDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'danger') {
                statusMessageDiv.classList.add('bg-red-100', 'text-red-700');
            } else { // info
                statusMessageDiv.classList.add('bg-blue-100', 'text-blue-700');
            }
        }
    </script>
</body>
</html>
